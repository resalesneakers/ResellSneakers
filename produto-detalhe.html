<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Detalhe do Produto - ResellSneakers</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; font-family: 'Inter', Arial, sans-serif; }
    .container { max-width: 1100px; margin: 0 auto; padding: 0 16px; }
    .product-section { display: flex; flex-wrap: wrap; gap: 32px; background: #fff; border-radius: 16px; box-shadow: 0 2px 16px rgba(0,0,0,0.06); padding: 32px 24px; margin-bottom: 32px; }
    .image-gallery { flex: 1 1 320px; min-width: 280px; max-width: 420px; display: flex; flex-direction: column; align-items: center; gap: 12px; }
    .main-image { width: 100%; max-width: 380px; aspect-ratio: 1; border-radius: 14px; object-fit: cover; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.04); margin-bottom: 8px; }
    .thumbnail-grid { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
    .thumbnail { width: 56px; height: 56px; border-radius: 8px; object-fit: cover; cursor: pointer; border: 2px solid transparent; background: #fff; }
    .thumbnail.active, .thumbnail:hover { border-color: #dc2626; }
    .product-info-col { flex: 2 1 400px; min-width: 280px; display: flex; flex-direction: column; gap: 18px; }
    .product-title { font-size: 2.1rem; font-weight: 700; color: #000; margin-bottom: 0.2em; }
    .product-subtitle { font-size: 1.1rem; color: #666; margin-bottom: 0.5em; }
    .current-price { font-size: 2rem; font-weight: 800; color: #dc2626; }
    .badge { font-size: 1rem; }
    .action-buttons { display: flex; flex-direction: column; gap: 12px; margin-bottom: 32px; }
    .btn { font-size: 1rem; font-weight: 600; border-radius: 8px; padding: 12px 0; margin-bottom: 8px; }
    .btn-lg { font-size: 1.15rem; }
    .btn-primary { background: #dc2626; color: #fff; border: none; }
    .btn-primary:hover { background: #991b1b; }
    .btn-outline-dark { border: 2px solid #dc2626; color: #dc2626; background: #fff; }
    .btn-outline-dark:hover { background: #dc2626; color: #fff; }
    .btn-outline-info { border: 2px solid #0dcaf0; color: #0dcaf0; background: #fff; }
    .btn-outline-info:hover { background: #0dcaf0; color: #fff; }
    .btn-success { background: #16a34a; color: #fff; border: none; }
    .btn-success:hover { background: #166534; }
    .product-details { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); padding: 20px 18px; margin-bottom: 18px; }
    .details-grid { display: grid; gap: 10px; }
    .detail-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #f8f9fa; }
    .detail-row:last-child { border-bottom: none; }
    .detail-label { color: #666; font-weight: 500; }
    .detail-value { font-weight: 600; color: #000; }
    @media (max-width: 991px) { .product-section { flex-direction: column; padding: 18px 6px; } .image-gallery, .product-info-col { max-width: 100%; min-width: 0; } }
    @media (max-width: 600px) { .container { padding: 0 4px; } .product-section { padding: 8px 2px; gap: 18px; } .main-image { max-width: 98vw; } .btn { font-size: 0.98rem; padding: 10px 0; } .product-title { font-size: 1.2rem; } }
  </style>
</head>
<body>
  <div id="menu-container"></div>
  <script>fetch('menu.html').then(res => res.text()).then(html => { document.getElementById('menu-container').innerHTML = html; });</script>
  <div class="container">
    <nav class="breadcrumb mt-4"><a href="home.html">‚Üê Voltar aos produtos Sneakers</a><span id="breadcrumbProduto"></span></nav>
    <div class="product-section row g-4">
      <div class="col-12 col-md-5 image-gallery">
        <img id="mainImage" src="images/no-image.png" class="main-image mb-2" alt="Imagem principal">
        <div class="thumbnail-grid" id="thumbnailGrid"></div>
      </div>
      <div class="col-12 col-md-7 product-info-col">
        <div class="product-title" id="productTitle"></div>
        <div class="product-subtitle" id="productSubtitle"></div>
        <div class="d-flex align-items-center gap-2 mb-2">
          <span class="current-price" id="productPrice"></span>
          <span class="badge bg-light text-dark" id="productCondition"></span>
        </div>
        <div id="detailsGrid" class="details-grid"></div>
        <div class="action-buttons">
          <button class="btn btn-primary btn-lg w-100" id="btnComprar">Comprar Agora</button>
          <button class="btn btn-outline-dark btn-lg w-100" id="btnCarrinho">Adicionar ao Carrinho</button>
          <button class="btn btn-outline-dark btn-lg w-100" id="btnFavorito">üíô Adicionar aos Favoritos</button>
          <button class="btn btn-success btn-lg w-100" id="btnChatVendedor"><i class="fa fa-comments"></i> Conversar com o Vendedor</button>
          <button class="btn btn-outline-info btn-lg w-100" id="btnCompartilhar"><i class="fa fa-share"></i> Compartilhar</button>
        </div>
        <div id="sellerInfo" class="mt-4"></div>
      </div>
    </div>
    <div id="suggestedProducts" class="mt-5"></div>
  </div>
  <script type="module">
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { doc, getDoc, collection, query, where, getDocs, addDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";
    import { auth, db, storage } from './firebase-config.js';
    const params = new URLSearchParams(window.location.search);
    const productId = params.get('id');
    if (!productId) {
      document.body.innerHTML = '<div class="container py-5 text-center"><h2>Produto n√£o encontrado.</h2></div>';
      throw new Error('Produto n√£o encontrado');
    }
    let user = null;
    let product = null;
    onAuthStateChanged(auth, async (u) => {
      user = u;
      await carregarProduto();
    });
    async function carregarProduto() {
      const docRef = doc(db, 'produtos', productId);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) {
        document.body.innerHTML = '<div class="container py-5 text-center"><h2>Produto n√£o encontrado.</h2></div>';
        return;
      }
      product = docSnap.data();
      document.getElementById('productTitle').textContent = product.nome || 'Produto';
      document.getElementById('productSubtitle').textContent = product.marca || '';
      document.getElementById('productPrice').textContent = product.preco ? `‚Ç¨${product.preco}` : '--';
      document.getElementById('productCondition').textContent = product.condicao || 'Usado';
      document.getElementById('breadcrumbProduto').textContent = `${product.marca || ''} > ${product.nome || ''}`;
      // Imagens
      let mainUrl = 'images/banner1.png';
      let imagensUrls = [];
      if (product.imagemPrincipal) {
        try {
          let url = product.imagemPrincipal;
          if (url.startsWith('http')) {
            mainUrl = url;
            imagensUrls.push(url);
          } else {
            // Tenta buscar downloadURL, se falhar usa o caminho como fallback
            try {
              const downloadUrl = await getDownloadURL(ref(storage, url));
              mainUrl = downloadUrl;
              imagensUrls.push(downloadUrl);
            } catch (e) {
              console.warn('Erro ao buscar downloadURL da imagem principal:', e, url);
              mainUrl = url;
              imagensUrls.push(url);
            }
          }
        } catch (e) {
          console.warn('Erro inesperado ao processar imagem principal:', e);
        }
      }
      if (product.imagens && Array.isArray(product.imagens) && product.imagens.length > 0) {
        for (let idx = 0; idx < product.imagens.length; idx++) {
          try {
            let path = product.imagens[idx];
            if (path.startsWith('http')) {
              if (!imagensUrls.includes(path)) imagensUrls.push(path);
            } else {
              try {
                const downloadUrl = await getDownloadURL(ref(storage, path));
                if (!imagensUrls.includes(downloadUrl)) imagensUrls.push(downloadUrl);
              } catch (e) {
                console.warn('Erro ao buscar downloadURL de imagem extra:', e, path);
                if (!imagensUrls.includes(path)) imagensUrls.push(path);
              }
            }
          } catch (e) {
            console.warn('Erro inesperado ao processar imagem extra:', e);
          }
        }
      }
      const mainImage = document.getElementById('mainImage');
      mainImage.src = imagensUrls[0] || mainUrl;
      mainImage.onerror = () => { mainImage.src = 'images/banner1.png'; };
      // Galeria
      const thumbGrid = document.getElementById('thumbnailGrid');
      thumbGrid.innerHTML = '';
      if (imagensUrls.length > 0) {
        imagensUrls.forEach((url, idx) => {
          const img = document.createElement('img');
          img.src = url;
          img.className = 'thumbnail';
          if (idx === 0) img.classList.add('active');
          img.onclick = () => {
            mainImage.src = url;
            thumbGrid.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
            img.classList.add('active');
          };
          img.ondblclick = () => showLightbox(url);
          thumbGrid.appendChild(img);
        });
        mainImage.onclick = () => showLightbox(mainImage.src);
      } else {
        mainImage.src = mainUrl;
      }
      // Detalhes
      const details = [
        { label: 'Marca', value: product.marca },
        { label: 'Modelo', value: product.modelo },
        { label: 'Colorway', value: product.colorway },
        { label: 'Ano de Lan√ßamento', value: product.ano },
        { label: 'SKU', value: product.sku },
        { label: 'Condi√ß√£o', value: product.condicao },
        { label: 'Descri√ß√£o', value: product.descricao }
      ];
      const detailsGrid = document.getElementById('detailsGrid');
      detailsGrid.innerHTML = '';
      details.forEach(d => { if (d.value) detailsGrid.innerHTML += `<div class='detail-row'><span class='detail-label'>${d.label}</span><span class='detail-value'>${d.value}</span></div>`; });
      // Vendedor
      if (product.vendedorId) {
        try {
          const userRef = doc(db, 'usuarios', product.vendedorId);
          const userSnap = await getDoc(userRef);
          if (userSnap.exists()) {
            const vendedor = userSnap.data();
            document.getElementById('sellerInfo').innerHTML = `
              <div class='seller-header d-flex align-items-center gap-3 mb-2'>
                <img src='${vendedor.foto || 'images/default-profile.png'}' alt='Seller' class='seller-avatar'>
                <div class='seller-details'>
                  <h3 class='mb-0'>${vendedor.nome || 'Vendedor'}</h3>
                  <div class='seller-rating'><span class='stars'>‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span><span>4.9 (127 avalia√ß√µes)</span></div>
                  <a href='perfil.html?id=${product.vendedorId}' class='btn btn-link p-0'>Ver perfil</a>
                </div>
                <button class='btn btn-outline-success ms-auto' id='btnChatVendedor2'><i class='fa fa-comments'></i> Chat</button>
              </div>
            `;
            document.getElementById('btnChatVendedor').onclick = () => {
              window.location.href = `chat.html?produto=${productId}&vendedor=${product.vendedorId}`;
            };
            document.getElementById('btnChatVendedor2').onclick = () => {
              window.location.href = `chat.html?produto=${productId}&vendedor=${product.vendedorId}`;
            };
          }
        } catch {}
      }
      // Favoritos
      const favBtn = document.getElementById('btnFavorito');
      async function atualizarFavoritoBtn() {
        if (!user) {
          favBtn.textContent = 'üíô Adicionar aos Favoritos';
          favBtn.classList.remove('btn-danger');
          favBtn.classList.add('btn-outline-dark');
          return;
        }
        const favRef = query(collection(db, "favoritos"), where("userId", "==", user.uid), where("produtoId", "==", productId));
        const favSnap = await getDocs(favRef);
        if (favSnap.empty) {
          favBtn.textContent = 'üíô Adicionar aos Favoritos';
          favBtn.classList.remove('btn-danger');
          favBtn.classList.add('btn-outline-dark');
        } else {
          favBtn.textContent = '‚ù§Ô∏è Nos Favoritos';
          favBtn.classList.remove('btn-outline-dark');
          favBtn.classList.add('btn-danger');
        }
      }
      atualizarFavoritoBtn();
      favBtn.onclick = async () => {
        if (!user) { alert('Fa√ßa login para favoritar produtos.'); return; }
        const favRef = query(collection(db, "favoritos"), where("userId", "==", user.uid), where("produtoId", "==", productId));
        const favSnap = await getDocs(favRef);
        if (favSnap.empty) {
          await addDoc(collection(db, "favoritos"), { userId: user.uid, produtoId: productId });
          alert('Adicionado aos favoritos!');
        } else {
          await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js').then(({ deleteDoc }) => deleteDoc(favSnap.docs[0].ref));
          alert('Removido dos favoritos.');
        }
        atualizarFavoritoBtn();
      };
      // Comprar agora
      document.getElementById('btnComprar').onclick = () => {
        window.location.href = `checkout.html?id=${productId}`;
      };
      // Adicionar ao carrinho
      document.getElementById('btnCarrinho').onclick = async () => {
        if (!user) { alert('Fa√ßa login para adicionar ao carrinho.'); return; }
        const carrinhoRef = doc(db, 'carrinhos', user.uid);
        let carrinhoSnap = await getDoc(carrinhoRef);
        let produtos = carrinhoSnap.exists() ? (carrinhoSnap.data().produtos || []) : [];
        if (!produtos.includes(productId)) produtos.push(productId);
        await setDoc(carrinhoRef, { produtos });
        alert('Adicionado ao carrinho!');
        setTimeout(() => window.location.href = 'carrinho.html', 1000);
      };
      // Compartilhar
      document.getElementById('btnCompartilhar').onclick = () => {
        const url = window.location.href;
        if (navigator.share) {
          navigator.share({ title: product.nome, url });
        } else {
          navigator.clipboard.writeText(url);
          alert('Link copiado!');
        }
      };
    }
    // Lightbox para imagens
    function showLightbox(url) {
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = 0;
      overlay.style.left = 0;
      overlay.style.width = '100vw';
      overlay.style.height = '100vh';
      overlay.style.background = 'rgba(0,0,0,0.8)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = 9999;
      overlay.onclick = () => document.body.removeChild(overlay);
      const img = document.createElement('img');
      img.src = url;
      img.style.maxWidth = '90vw';
      img.style.maxHeight = '90vh';
      img.style.borderRadius = '16px';
      overlay.appendChild(img);
      document.body.appendChild(overlay);
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>