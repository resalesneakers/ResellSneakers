<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar Produto - ResellSneakers</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      padding-top: 4.5rem;
    }
    .container {
      max-width: 600px;
    }
    #previewImagem {
      max-width: 100%;
      height: auto;
      margin-top: 1rem;
      display: none;
    }
  </style>
</head>
<body>

<!-- Barra de Navegação -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="home.html">ResellSneakers</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="perfil.html">Perfil</a></li>
        <li class="nav-item"><a class="nav-link" href="editar-perfil.html">Editar Perfil</a></li>
        <li class="nav-item"><a class="nav-link" href="favoritos.html">Favoritos</a></li>
        <li class="nav-item"><a class="nav-link" href="produtos.html">Produtos</a></li>
        <li class="nav-item"><a class="nav-link text-danger" href="#" id="logoutBtn">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container">
  <h2 class="mb-4">Editar Produto</h2>
  <form id="formEditarProduto">
    <div id="mensagem"></div>
    <div class="mb-3">
      <label for="nome" class="form-label">Nome do Produto</label>
      <input type="text" class="form-control" id="nome" required>
    </div>

    <div class="mb-3">
      <label for="preco" class="form-label">Preço (€)</label>
      <input type="number" class="form-control" id="preco" required>
    </div>

    <div class="mb-3">
      <label for="condicao" class="form-label">Condição</label>
      <select class="form-select" id="condicao" required>
        <option value="">Seleciona...</option>
        <option value="Novo">Novo</option>
        <option value="Usado - Excelente">Usado - Excelente</option>
        <option value="Usado - Bom">Usado - Bom</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="disponibilidade" class="form-label">Disponibilidade</label>
      <select class="form-select" id="disponibilidade" required>
        <option value="">Seleciona...</option>
        <option value="venda">Venda</option>
        <option value="troca">Troca</option>
        <option value="venda e troca">Venda e Troca</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Imagem Atual</label>
      <img id="previewImagem" src="#" alt="Imagem atual">
    </div>

    <div class="mb-3">
      <label for="imagemProduto" class="form-label">Substituir Imagem</label>
      <input type="file" class="form-control" id="imagemProduto" accept="image/*">
    </div>

    <button type="submit" class="btn btn-primary">Guardar Alterações</button>
  </form>
  <div id="mensagem" class="mt-3 fw-bold"></div>
</div>

<!-- Firebase & Bootstrap -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBa5JgoDsj-sqSbe2hzuJQwA-SFfAyxvBY",
    authDomain: "resalesneakers-e17cb.firebaseapp.com",
    projectId: "resalesneakers-e17cb",
    storageBucket: "resalesneakers-e17cb.appspot.com",
    messagingSenderId: "698715655625",
    appId: "1:698715655625:web:fde7f7a7f2da0037792c18"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  const params = new URLSearchParams(window.location.search);
  const produtoId = params.get("id");
  const imagemInput = document.getElementById("imagemProduto");
  const previewImagem = document.getElementById("previewImagem");
  const form = document.getElementById('formEditarProduto');
  const mensagemEl = document.getElementById('mensagem');

  let produtoAtual = null;
  let imagemAnterior = null;
  let user = null;

  auth.onAuthStateChanged(async (u) => {
    if (!u) return window.location.href = "log.html";
    user = u;

    const doc = await db.collection("produtos").doc(produtoId).get();
    if (!doc.exists) return alert("Produto não encontrado.");

    produtoAtual = doc.data();
    document.getElementById("nome").value = produtoAtual.nome || "";
    document.getElementById("preco").value = produtoAtual.preco || "";
    document.getElementById("condicao").value = produtoAtual.condicao || "";
    document.getElementById("disponibilidade").value = produtoAtual.disponibilidade || "";

    if (produtoAtual.imagemPrincipal) {
      previewImagem.src = produtoAtual.imagemPrincipal;
      previewImagem.style.display = "block";
      imagemAnterior = produtoAtual.imagemPrincipal;
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    mensagemEl.textContent = '';
    mensagemEl.className = '';

    const nome = document.getElementById("nome").value.trim();
    const preco = parseFloat(document.getElementById("preco").value);
    const condicao = document.getElementById("condicao").value;
    const disponibilidade = document.getElementById("disponibilidade").value;

    if (nome.length < 3) return mostrarMensagem("O nome deve ter pelo menos 3 caracteres.", "danger", submitBtn);
    if (isNaN(preco) || preco <= 0) return mostrarMensagem("O preço deve ser maior que 0.", "danger", submitBtn);
    if (!condicao || !disponibilidade) return mostrarMensagem("Preencha todos os campos obrigatórios.", "danger", submitBtn);

    try {
      let imagemURL = produtoAtual.imagemPrincipal;
      const novaImagem = imagemInput.files[0];

      if (novaImagem) {
        if (imagemAnterior) {
          try {
            const antigaRef = storage.refFromURL(imagemAnterior);
            await antigaRef.delete();
          } catch (err) {
            console.warn("Erro ao apagar imagem anterior:", err);
          }
        }

        const nomeImagem = `${Date.now()}_${novaImagem.name}`;
        const storageRef = storage.ref().child(`produtos/${user.uid}/${nomeImagem}`);
        const uploadResult = await storageRef.put(novaImagem);
        imagemURL = await uploadResult.ref.getDownloadURL();
      }

      await db.collection("produtos").doc(produtoId).update({
        nome,
        preco,
        condicao,
        disponibilidade,
        imagemPrincipal: imagemURL,
        ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
      });

      mostrarMensagem("Produto atualizado com sucesso!", "success", submitBtn);
    } catch (error) {
      console.error("Erro ao atualizar:", error);
      mostrarMensagem("Erro ao atualizar o produto.", "danger", submitBtn);
    }
  });

  function mostrarMensagem(texto, tipo, btn) {
    mensagemEl.textContent = texto;
    mensagemEl.className = `alert alert-${tipo} mt-3`;
    if (btn) btn.disabled = false;
  }

  // Botão logout
  document.getElementById('logoutBtn').addEventListener('click', () => {
    auth.signOut().then(() => window.location.href = "log.html");
  });
</script>
</body>
</html>
