<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meu Perfil - ResellSneakers</title>
  <!-- Bootstrap e FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="navbar-styles.css">
  <style>
    .profile-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.07);
      padding: 2rem;
      margin-bottom: 2rem;
    }
    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #eee;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .profile-stats .stat {
      min-width: 90px;
      text-align: center;
    }
    .profile-stats .stat .number {
      font-size: 1.3rem;
      font-weight: bold;
      color: #dc2626;
    }
    .tab-pane {
      padding-top: 2rem;
    }
    .product-card {
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      margin-bottom: 1.5rem;
      background: #fff;
      transition: transform 0.2s;
    }
    .product-card:hover {
      transform: translateY(-4px) scale(1.01);
    }
    .product-img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 12px 12px 0 0;
    }
    .empty-state {
      text-align: center;
      color: #aaa;
      padding: 3rem 0;
    }
    @media (max-width: 768px) {
      .profile-card { padding: 1rem; }
      .profile-avatar { width: 90px; height: 90px; }
    }
  </style>
</head>
<body>
  <div id="menu-container"></div>
  <script>
    fetch('menu.html').then(res => res.text()).then(html => {
      document.getElementById('menu-container').innerHTML = html;
    });
  </script>
  <div class="container mt-4">
    <div class="profile-card text-center">
      <div class="row align-items-center">
        <div class="col-12 col-md-3 mb-3 mb-md-0">
          <img id="profile-avatar" src="images/default-profile.png" class="profile-avatar" alt="Avatar">
        </div>
        <div class="col-12 col-md-6 text-md-start">
          <h2 id="profile-name" class="fw-bold mb-1">Nome do Usuário</h2>
          <div id="profile-email" class="text-muted mb-2">email@exemplo.com</div>
          <span class="badge bg-light text-dark mb-2">Membro desde <span id="join-date"></span></span>
          <div class="profile-stats d-flex flex-wrap gap-3 mt-2 justify-content-center justify-content-md-start">
            <div class="stat"><div class="number" id="listings-count">0</div><div>Produtos</div></div>
            <div class="stat"><div class="number" id="sales-count">0</div><div>Vendas</div></div>
            <div class="stat"><div class="number" id="purchases-count">0</div><div>Compras</div></div>
            <div class="stat"><div class="number" id="rating">0.0</div><div>Classificação</div></div>
          </div>
        </div>
        <div class="col-12 col-md-3 text-center text-md-end mt-3 mt-md-0">
          <div class="fs-4 fw-bold text-success" id="wallet-balance">€0.00</div>
          <div class="text-muted">Saldo na Carteira</div>
          <button class="btn btn-outline-primary mt-2" id="add-funds-btn"><i class="fa fa-plus"></i> Adicionar Fundos</button>
        </div>
      </div>
    </div>

    <!-- Tabs Bootstrap -->
    <ul class="nav nav-tabs" id="perfilTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="produtos-tab" data-bs-toggle="tab" data-bs-target="#produtos" type="button" role="tab">Meus Produtos</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="transacoes-tab" data-bs-toggle="tab" data-bs-target="#transacoes" type="button" role="tab">Transações</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="notificacoes-tab" data-bs-toggle="tab" data-bs-target="#notificacoes" type="button" role="tab">Notificações</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="definicoes-tab" data-bs-toggle="tab" data-bs-target="#definicoes" type="button" role="tab">Definições</button>
      </li>
    </ul>
    <div class="tab-content" id="perfilTabsContent">
      <!-- Produtos -->
      <div class="tab-pane fade show active" id="produtos" role="tabpanel">
        <div class="row" id="listings-container">
          <div class="empty-state" id="empty-listings">
            <i class="fa fa-box-open fa-2x mb-2"></i>
            <h5>Sem Produtos Publicados</h5>
            <p>Comece a vender os seus sneakers favoritos.</p>
            <a href="vender.html" class="btn btn-primary mt-2">Adicionar Produto</a>
          </div>
        </div>
      </div>
      <!-- Transações -->
      <div class="tab-pane fade" id="transacoes" role="tabpanel">
        <div id="transaction-list"></div>
        <div class="empty-state" id="empty-transactions" style="display:none;">
          <i class="fa fa-money-bill-wave fa-2x mb-2"></i>
          <h5>Sem Transações</h5>
          <p>Ainda não realizou nenhuma transação.</p>
        </div>
      </div>
      <!-- Notificações -->
      <div class="tab-pane fade" id="notificacoes" role="tabpanel">
        <div id="notificacoes-list"></div>
        <div class="empty-state" id="empty-notificacoes" style="display:none;">
          <i class="fa fa-bell fa-2x mb-2"></i>
          <h5>Sem notificações</h5>
          <p>Você ainda não recebeu nenhuma notificação.</p>
        </div>
      </div>
      <!-- Definições -->
      <div class="tab-pane fade" id="definicoes" role="tabpanel">
        <p>Funcionalidades de configurações em breve.</p>
      </div>
    </div>
  </div>

  <!-- Firebase SDK e Config -->
  <script type="module">
    import { auth, db } from './firebase-config.js';
    import { onAuthStateChanged, sendPasswordResetEmail, deleteUser } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { doc, getDoc, collection, query, where, getDocs, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Carregar menu
    // fetch('menu.html').then(res => res.text()).then(html => {
    //   document.getElementById('menu-container').innerHTML = html;
    // });

    // Carregar dados do usuário
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'log.html';
        return;
      }
      // Dados básicos
      document.getElementById('profile-name').textContent = user.displayName || 'Usuário';
      document.getElementById('profile-email').textContent = user.email;
      document.getElementById('profile-avatar').src = user.photoURL || 'images/default-profile.png';

      // Buscar dados extras do Firestore
      const userRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);
      let userData = {};
      if (userSnap.exists()) {
        userData = userSnap.data();
        // Data de registro
        if (userData.createdAt && userData.createdAt.toDate) {
          document.getElementById('join-date').textContent = userData.createdAt.toDate().toLocaleDateString('pt-PT');
        } else {
          document.getElementById('join-date').textContent = '---';
        }
        // Saldo
        document.getElementById('wallet-balance').textContent = '€' + (userData.walletBalance ? userData.walletBalance.toFixed(2) : '0.00');
        // Estatísticas
        document.getElementById('listings-count').textContent = userData.listingsCount || 0;
        document.getElementById('sales-count').textContent = userData.salesCount || 0;
        document.getElementById('purchases-count').textContent = userData.purchasesCount || 0;
        document.getElementById('rating').textContent = userData.rating ? userData.rating.toFixed(1) : '0.0';
      } else {
        document.getElementById('join-date').textContent = '---';
      }

      // Carregar produtos do usuário
      const listingsContainer = document.getElementById('listings-container');
      const emptyListings = document.getElementById('empty-listings');
      listingsContainer.innerHTML = '';
      const produtosRef = collection(db, "produtos");
      const q = query(produtosRef, where("userId", "==", user.uid), orderBy("dataCriacao", "desc"));
      const querySnapshot = await getDocs(q);
      if (querySnapshot.empty) {
        emptyListings.style.display = 'block';
      } else {
        emptyListings.style.display = 'none';
        querySnapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const card = document.createElement('div');
          card.className = 'col-12 col-md-6 col-lg-4';
          card.innerHTML = `
            <div class="product-card h-100">
              <img src="${data.imagemPrincipal || 'images/no-image.png'}" class="product-img" alt="${data.nome}">
              <div class="p-3">
                <h5 class="mb-1">${data.nome}</h5>
                <div class="mb-2 text-muted">${data.marca || ''}</div>
                <div class="fw-bold text-danger mb-2">€${data.preco}</div>
                <div class="mb-2"><span class="badge bg-light text-dark">${data.condicao || ''}</span></div>
                <a href="produto-detalhe.html?id=${docSnap.id}" class="btn btn-outline-dark btn-sm w-100 mb-1">Ver Detalhes</a>
                <a href="editar-produto.html?id=${docSnap.id}" class="btn btn-outline-primary btn-sm w-100">Editar</a>
              </div>
            </div>
          `;
          listingsContainer.appendChild(card);
        });
      }

      // --- Transações (Compras e Vendas) ---
      const transactionList = document.getElementById('transaction-list');
      const emptyTransactions = document.getElementById('empty-transactions');
      transactionList.innerHTML = '';
      // Compras
      const comprasRef = collection(db, 'compras');
      const comprasQ = query(comprasRef, where('userId', '==', user.uid), orderBy('data', 'desc'));
      const comprasSnap = await getDocs(comprasQ);
      let transacoesHtml = '';
      if (!comprasSnap.empty) {
        comprasSnap.forEach(docu => {
          const compra = docu.data();
          transacoesHtml += `<div class='mb-3 p-3 border rounded bg-light'><b>Compra</b> - ${new Date(compra.data.seconds*1000).toLocaleDateString('pt-PT')}<ul>`;
          compra.produtos.forEach(p => {
            transacoesHtml += `<li>${p.nome} - €${p.preco}</li>`;
          });
          transacoesHtml += `</ul><span class='fw-bold'>Total: €${compra.total}</span></div>`;
        });
      }
      // Vendas
      const vendasQ = query(produtosRef, where('userId', '==', user.uid), where('disponibilidade', '==', 'vendido'), orderBy('dataCriacao', 'desc'));
      const vendasSnap = await getDocs(vendasQ);
      if (!vendasSnap.empty) {
        vendasSnap.forEach(docu => {
          const venda = docu.data();
          transacoesHtml += `<div class='mb-3 p-3 border rounded bg-light'><b>Venda</b> - ${venda.nome} - €${venda.preco} (${new Date(venda.dataCriacao.seconds*1000).toLocaleDateString('pt-PT')})</div>`;
        });
      }
      if (transacoesHtml) {
        transactionList.innerHTML = transacoesHtml;
        emptyTransactions.style.display = 'none';
      } else {
        emptyTransactions.style.display = 'block';
      }

      // --- Notificações ---
      const notificacoesList = document.getElementById('notificacoes-list');
      const emptyNotificacoes = document.getElementById('empty-notificacoes');
      notificacoesList.innerHTML = '';
      const notificacoesRef = collection(db, 'notificacoes');
      const notificacoesQ = query(notificacoesRef, where('userId', '==', user.uid), orderBy('data', 'desc'));
      const notificacoesSnap = await getDocs(notificacoesQ);
      if (!notificacoesSnap.empty) {
        notificacoesSnap.forEach(docu => {
          const n = docu.data();
          notificacoesList.innerHTML += `<div class='mb-2 p-2 border rounded bg-light'><b>${n.tipo || 'Notificação'}</b>: ${n.mensagem} <span class='text-muted small'>(${new Date(n.data.seconds*1000).toLocaleString('pt-PT')})</span></div>`;
        });
        emptyNotificacoes.style.display = 'none';
      } else {
        emptyNotificacoes.style.display = 'block';
      }

      // --- Definições ---
      const definicoesTab = document.getElementById('definicoes');
      definicoesTab.innerHTML = `
        <div class='mt-3'>
          <a href='editar-perfil.html' class='btn btn-outline-primary mb-2'><i class='fa fa-user-edit'></i> Editar Perfil</a><br>
          <button class='btn btn-outline-warning mb-2' id='btn-reset-password'><i class='fa fa-key'></i> Alterar Password</button><br>
          <button class='btn btn-outline-danger' id='btn-delete-account'><i class='fa fa-trash'></i> Apagar Conta</button>
        </div>
        <div id='definicoes-msg' class='mt-3'></div>
      `;
      document.getElementById('btn-reset-password').onclick = async () => {
        await sendPasswordResetEmail(auth, user.email);
        document.getElementById('definicoes-msg').innerHTML = '<div class="alert alert-info">Email de redefinição de password enviado!</div>';
      };
      document.getElementById('btn-delete-account').onclick = async () => {
        if (confirm('Tem a certeza que deseja apagar a sua conta? Esta ação é irreversível.')) {
          try {
            await deleteUser(user);
            window.location.href = 'index.html';
          } catch (e) {
            document.getElementById('definicoes-msg').innerHTML = '<div class="alert alert-danger">Erro ao apagar conta. Faça login novamente e tente de novo.</div>';
          }
        }
      };
    });
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script src="navbar-script.js"></script>
</body>
</html>